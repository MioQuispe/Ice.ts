scenario,run_mode,existing_server,args_mismatch,args_mismatch_selection,ephemeral_leases_before,expected_action,pid_change,server_after,ephemeral_leases_after,error,notes
Cold start (FG),fg,none,no,-,0,spawn_new,new,managed_fg,1,-,"“No server running, foreground run spawns a new managed_fg and acquires one ephemeral lease.”"
Cold start (BG),bg,none,no,-,0,spawn_new,new,managed_bg,0,-,"“No server running, background run spawns a new managed_bg with long-TTL lease, no ephemeral leases.”"
"“Managed FG exists, no mismatch, run FG”",fg,managed_fg,no,-,1+,reuse,same,managed_fg,2+,-,"“An FG server with at least one ephemeral lease exists, another FG run reuses it and increments the lease count.”"
"“Managed BG exists, no mismatch, run BG”",bg,managed_bg,no,-,0,reuse,same,managed_bg,0,-,"“A BG server exists, another BG run reuses it, ephemeral lease count stays zero.”"
"“Managed FG exists, no mismatch, run BG”",bg,managed_fg,no,-,1+,reuse,same,managed_fg,1+,-,"“BG run attaches to existing FG-managed server, does not change ephemeral lease count.”"
"“Managed BG exists, no mismatch, run FG”",fg,managed_bg,no,-,0,reuse,same,managed_bg,1,-,FG run attaches to BG-managed server and adds one ephemeral lease.
"“Managed FG exists, mismatch+reuse, run FG”",fg,managed_fg,yes,reuse,1+,reuse,same,managed_fg,2+,-,"“Args differ but user chose reuse, keep the existing FG server and increment ephemeral leases.”"
"“Managed BG exists, mismatch+reuse, run BG”",bg,managed_bg,yes,reuse,0,reuse,same,managed_bg,0,-,"“Args differ on BG but reuse chosen, continue with the existing BG server.”"
"“Managed FG exists, mismatch+restart, leases>0, run FG”",fg,managed_fg,yes,restart,1+,reject_in_use,same,managed_fg,1+,in-use,"“Cannot restart FG server because other ephemeral leases are active, reject to avoid disrupting concurrent tasks.”"
"“Managed BG exists, mismatch+restart, leases=0, run BG”",bg,managed_bg,yes,restart,0,restart,new,managed_bg,0,-,Safe to restart BG server because no ephemeral leases are active.
"“Managed BG exists, mismatch+restart, leases>0, run BG”",bg,managed_bg,yes,restart,1+,reject_in_use,same,managed_bg,1+,in-use,"“Do not restart BG server while FG leases are active, reject to protect active work.”"
"“Manual server exists, no mismatch, reuse (FG)”",fg,manual,no,reuse,0,attach_manual,same,manual,0,-,"“Attach to a manually started server, per spec no leases are created when attaching to manual servers.”"
"“Manual server exists, no mismatch, reuse (BG)”",bg,manual,no,reuse,0,attach_manual,same,manual,0,-,"“Attach to a manually started server from BG, no ephemeral lease is added.”"
"“Manual server exists, mismatch+reuse (FG)”",fg,manual,yes,reuse,0,attach_manual,same,manual,0,-,"“Args differ but reuse chosen, attach to manual server, no leases created per spec.”"
"“Manual server exists, mismatch+restart (FG), leases=0”",fg,manual,yes,restart,0,reject_manual,same,manual,0,manual_present,Fail-fast: cannot restart a manual server we do not manage.
"“Manual server exists, mismatch+restart (FG), leases>0”",fg,manual,yes,restart,1+,reject_manual,same,manual,1+,manual_present,Fail-fast: cannot restart a manual server we do not manage (leases unaffected).
Parallel FG #1 (no server),fg,none,no,-,0,spawn_new,new,managed_fg,1,-,First FG task starts the server and acquires the first ephemeral lease.
Parallel FG #2 (server FG running),fg,managed_fg,no,-,1+,reuse,same,managed_fg,2+,-,Second FG task reuses the running FG server and increases ephemeral leases.
Parallel BG #1 (no server),bg,none,no,-,0,spawn_new,new,managed_bg,0,-,"“First BG task starts BG server with long-TTL lease, no ephemeral leases.”"
Parallel BG #2 (server BG running),bg,managed_bg,no,-,0,reuse,same,managed_bg,0,-,"“Second BG task reuses the BG server, ephemeral leases remain zero.”"
FG requests restart while BG managed exists (protect BG),fg,managed_bg,yes,restart,0,reject_in_use,same,managed_bg,0,protected,"“FG run may not disrupt a BG-managed server even with no FG leases, protect BG process.”"
BG requests restart while FG exists (leases>0),bg,managed_fg,yes,restart,1+,reject_in_use,same,managed_fg,1+,in-use,"“BG run may not restart while FG ephemeral leases are active, reject to protect concurrent tasks.”"